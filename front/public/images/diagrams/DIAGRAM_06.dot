digraph MinimaxPipeline {
    rankdir=LR;
    graph [
        bgcolor="transparent"
        fontname="Helvetica"
        pad="0.45"
        nodesep="0.40"
        ranksep="0.50"
        compound=true
        newrank=true
        label="Minimax Request-Handling Pipeline"
        labelloc="t"
        labeljust="c"
        fontsize=14
        fontcolor="#1e293b"
    ];
    node [
        shape=box
        style="rounded,filled"
        fontname="Helvetica"
        fontsize=10
        margin="0.12,0.07"
        color="#334155"
        fillcolor="#ffffff"
    ];
    edge [
        color="#334155"
        arrowsize=0.7
        penwidth=1.0
        fontname="Helvetica"
        fontsize=9
    ];

    // 1) I/O: WebSocket Request
    subgraph cluster_input {
        label="Client Request";
        fontsize=12;
        style="rounded";
        color="#2563eb";
        bgcolor="#eff6ff";
        margin=14;

        ws_req [label="WebSocket Request\n(board state + difficulty\nas JSON)", color="#1d4ed8", fillcolor="#ffffff"];
    }

    // 2) JSON Parser
    subgraph cluster_parse {
        label="Parsing";
        fontsize=12;
        style="rounded";
        color="#0891b2";
        bgcolor="#ecfeff";
        margin=14;

        json_parse [label="JSON Parser\ndecode board array,\nplayer info, last move", color="#0e7490", fillcolor="#ffffff"];
    }

    // 3) Board
    subgraph cluster_board {
        label="Board Representation";
        fontsize=12;
        style="rounded";
        color="#0d9488";
        bgcolor="#f0fdfa";
        margin=14;

        board [label="Board\nuint64_t[19]Ã—2 bitboard\n(one array per player)", color="#0f766e", fillcolor="#ffffff"];
        zobrist [label="Zobrist Hash\nincremental update", color="#0f766e", fillcolor="#ffffff"];

        board -> zobrist;
    }

    // 4) Search Engine with difficulty branches
    subgraph cluster_search {
        label="Search Engine";
        fontsize=12;
        style="rounded";
        color="#7c3aed";
        bgcolor="#ede9fe";
        margin=14;

        diff_dispatch [label="Difficulty\nDispatch", color="#6d28d9", fillcolor="#f5f3ff"];

        easy [label="Easy\nAlpha-Beta\ndepth 5", color="#8b5cf6", fillcolor="#ede9fe"];
        medium [label="Medium\nIterative Deepening\ndepth <= 10, 0.4s limit", color="#7c3aed", fillcolor="#ede9fe"];
        hard [label="Hard\nPVS\ndepth 10", color="#6d28d9", fillcolor="#ede9fe"];

        diff_dispatch -> easy;
        diff_dispatch -> medium;
        diff_dispatch -> hard;

        search_opts [shape=note, style="dashed,filled", color="#6d28d9", fillcolor="#f5f3ff",
            label="Search optimizations\n+ Transposition Table (TT)\n+ Killer Moves (MAX_DEPTH+1 x 2)\n+ Quiescence Search (easy/medium only)"];
        diff_dispatch -> search_opts [arrowhead=none, style=dotted, color="#6d28d9", constraint=false];

        // Evaluation sub-component (called at leaf nodes)
        subgraph cluster_eval {
            label="Evaluation (at leaf nodes)";
            fontsize=10;
            style="rounded,dashed";
            color="#16a34a";
            bgcolor="#dcfce7";
            margin=10;

            eval_std [label="Pattern Lookup Table\nextract 18-bit window per axis\ntable[pattern] -> O(1) score\nEvalFn: evaluatePosition", color="#15803d", fillcolor="#f0fdf4"];
            eval_hard [label="Extended Pattern Evaluation\nEvalFn: evaluatePositionHard", color="#15803d", fillcolor="#f0fdf4"];
        }

        easy -> eval_std [style=dotted, color="#16a34a", fontcolor="#15803d", label="evaluatePosition", fontsize=8, constraint=false];
        medium -> eval_std [style=dotted, color="#16a34a", fontcolor="#15803d", label="evaluatePosition", fontsize=8, constraint=false];
        hard -> eval_hard [style=dotted, color="#16a34a", fontcolor="#15803d", label="evaluatePositionHard", fontsize=8, constraint=false];

        { rank=same; easy; medium; hard; eval_std; eval_hard; }
        { rank=same; diff_dispatch; search_opts; }
    }

    // 5) Response
    subgraph cluster_output {
        label="Client Response";
        fontsize=12;
        style="rounded";
        color="#2563eb";
        bgcolor="#eff6ff";
        margin=14;

        response [label="Response\nAI move coords,\nupdated board,\ncaptured stones,\neval score, time (ms)", color="#1d4ed8", fillcolor="#ffffff"];
    }

    // Main pipeline edges
    ws_req -> json_parse [ltail=cluster_input, lhead=cluster_parse];
    json_parse -> board [ltail=cluster_parse, lhead=cluster_board];
    zobrist -> diff_dispatch [ltail=cluster_board, lhead=cluster_search];

    merge [shape=point, width=0.15, label="", color="#334155", fillcolor="#334155"];
    easy -> merge [ltail=cluster_search, dir=none];
    medium -> merge [ltail=cluster_search, dir=none];
    hard -> merge [ltail=cluster_search, dir=none];
    merge -> response [lhead=cluster_output];
}
