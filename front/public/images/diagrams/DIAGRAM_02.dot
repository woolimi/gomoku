digraph PolicyValueNet {
  rankdir=TB;
  graph [pad="0.45", nodesep="0.40", ranksep="0.35", bgcolor="transparent",
         fontname="Helvetica", compound=true, newrank=true,
         label="PolicyValueNet Architecture\nReference config: board=19x19, history=5, planes=13, hidden=128, resblocks=12 | policy_channels=2, value_channels=1, action_size=361",
         labelloc="t", labeljust="c", fontsize=14, fontcolor="#1e293b"];
  node [shape=box, style="rounded,filled", fillcolor="#ffffff", color="#334155",
        fontname="Helvetica", fontsize=10, margin="0.12,0.07"];
  edge [color="#334155", arrowsize=0.7, penwidth=1.0, fontname="Helvetica", fontsize=9];

  input [label="Input Tensor\nshape: (B, 13, 19, 19)", fillcolor="#eff6ff", color="#2563eb"];

  subgraph cluster_shared {
    label="Shared Trunk (12 Residual Blocks)";
    fontname="Helvetica";
    fontsize=12;
    style="rounded";
    color="#2563eb";
    bgcolor="#dbeafe";
    margin=16;

    start [label="Start Block\nConv2d(in=13, out=128, k=3, p=1)\nBatchNorm2d(128) + ReLU", fillcolor="#eff6ff", color="#2563eb"];
    rb_conv1 [label="Residual Block (template)\nConv2d(in=128, out=128, k=3, p=1)", fillcolor="#eff6ff", color="#2563eb"];
    rb_bn1 [label="BatchNorm2d(128)", fillcolor="#eff6ff", color="#2563eb"];
    rb_relu1 [label="ReLU", fillcolor="#eff6ff", color="#2563eb"];
    rb_conv2 [label="Conv2d(in=128, out=128, k=3, p=1)", fillcolor="#eff6ff", color="#2563eb"];
    rb_bn2 [label="BatchNorm2d(128)", fillcolor="#eff6ff", color="#2563eb"];
    rb_add [label="Residual Add\n(main + skip)", fillcolor="#eff6ff", color="#2563eb"];
    rb_out [label="ReLU", fillcolor="#eff6ff", color="#2563eb"];
    rb_repeat_note [shape=note, style="dashed,filled", fillcolor="#eff6ff", color="#2563eb",
                    label="Residual block shown once\nrepeated x12 in code"];
  }

  subgraph cluster_policy {
    label="Policy Head";
    fontname="Helvetica";
    fontsize=12;
    style="rounded";
    color="#16a34a";
    bgcolor="#dcfce7";
    margin=16;

    p_conv [label="Conv2d(in=128, out=2, k=1)", fillcolor="#f0fdf4", color="#16a34a"];
    p_bn [label="BatchNorm2d(2)", fillcolor="#f0fdf4", color="#16a34a"];
    p_relu [label="ReLU", fillcolor="#f0fdf4", color="#16a34a"];
    p_flat [label="Flatten\n(B, 2, 19, 19) -> (B, 722)", fillcolor="#f0fdf4", color="#16a34a"];
    p_fc [label="Linear(in_features=722,\nout_features=361)", fillcolor="#f0fdf4", color="#16a34a"];
    p_out [label="Policy Logits\nshape: (B, 361)\n(illegal-move mask + softmax\napplied during MCTS)", fillcolor="#bbf7d0", color="#15803d"];
  }

  subgraph cluster_value {
    label="Value Head";
    fontname="Helvetica";
    fontsize=12;
    style="rounded";
    color="#7c3aed";
    bgcolor="#ede9fe";
    margin=16;

    v_conv [label="Conv2d(in=128, out=1, k=1)", fillcolor="#f5f3ff", color="#7c3aed"];
    v_bn [label="BatchNorm2d(1)", fillcolor="#f5f3ff", color="#7c3aed"];
    v_relu1 [label="ReLU", fillcolor="#f5f3ff", color="#7c3aed"];
    v_flat [label="Flatten\n(B, 1, 19, 19) -> (B, 361)", fillcolor="#f5f3ff", color="#7c3aed"];
    v_fc1 [label="Linear(in_features=361,\nout_features=256)", fillcolor="#f5f3ff", color="#7c3aed"];
    v_relu2 [label="ReLU", fillcolor="#f5f3ff", color="#7c3aed"];
    v_fc2 [label="Linear(in_features=256,\nout_features=1)", fillcolor="#f5f3ff", color="#7c3aed"];
    v_tanh [label="Tanh", fillcolor="#f5f3ff", color="#7c3aed"];
    v_out [label="State Value\nshape: (B, 1), range [-1, 1]", fillcolor="#ddd6fe", color="#6d28d9"];
  }

  input -> start;
  start -> rb_conv1;
  rb_conv1 -> rb_bn1 -> rb_relu1 -> rb_conv2 -> rb_bn2 -> rb_add -> rb_out;
  start -> rb_add [style=dashed, color="#1d4ed8", fontcolor="#1d4ed8", label="skip path"];
  rb_repeat_note -> rb_out [arrowhead=none, style=dotted, color="#1d4ed8", constraint=false];

  rb_out -> p_conv;
  p_conv -> p_bn -> p_relu -> p_flat -> p_fc -> p_out;

  rb_out -> v_conv;
  v_conv -> v_bn -> v_relu1 -> v_flat -> v_fc1 -> v_relu2 -> v_fc2 -> v_tanh -> v_out;

  { rank=same; p_conv; v_conv; }
  { rank=same; p_out; v_out; }
}
