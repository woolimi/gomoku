digraph AlphaZeroLoop {
    rankdir = LR;
    graph [
        bgcolor = "transparent"
        fontname = "Helvetica"
        pad = "0.35"
        nodesep = "0.35"
        ranksep = "0.50"
        compound = true
        newrank = true
    ];
    node [
        shape = box
        style = "rounded,filled"
        fontname = "Helvetica"
        fontsize = 10
        margin = "0.12,0.07"
        color = "#334155"
        fillcolor = "#ffffff"
    ];
    edge [
        color = "#334155"
        arrowsize = 0.7
        penwidth = 1.1
        fontname = "Helvetica"
        fontsize = 9
    ];

    // 1) Self-play
    subgraph cluster_selfplay {
        label = "Self-Play";
        fontsize = 12;
        style = "rounded";
        color = "#2563eb";
        bgcolor = "#eff6ff";
        margin = 14;

        sp_mcts [label = "MCTS Search\n(Dirichlet noise at root)", color = "#1d4ed8", fillcolor = "#ffffff"];
        sp_out [label = "Generate (s, π, z)", color = "#1d4ed8", fillcolor = "#ffffff"];

        sp_mcts -> sp_out;

        // Keep stage internals compact in LR layout (stack vertically)
        { rank = same; sp_mcts; sp_out; }
    }

    // Config notes for self-play (not a pipeline stage)
    sp_temp_note [
        shape = note
        style = "filled"
        fillcolor = "#f8fafc"
        color = "#64748b"
        fontcolor = "#334155"
        label = "Temperature sampling\nτ scheduled per iteration:\n0-30: 1.0, 31-100: 0.75"
    ];
    sp_opp_note [
        shape = note
        style = "filled"
        fillcolor = "#f8fafc"
        color = "#64748b"
        fontcolor = "#334155"
        label = "Opponent mix\nChampion self-play\n+ optional prev/random bots\n(e.g., prev 0.25, random 0.08)"
    ];
    sp_temp_note -> sp_mcts [arrowhead = none, style = dotted, color = "#64748b", constraint = false];
    sp_opp_note -> sp_mcts [arrowhead = none, style = dotted, color = "#64748b", constraint = false];

    // 2) Replay buffer
    subgraph cluster_buffer {
        label = "Replay Buffer";
        fontsize = 12;
        style = "rounded";
        color = "#0891b2";
        bgcolor = "#ecfeff";
        margin = 14;

        buf_store [label = "Store Tuples\n(state, policy, outcome)", color = "#0e7490", fillcolor = "#ffffff"];
        buf_cap [label = "Max 500K\nFIFO eviction", color = "#0e7490", fillcolor = "#ffffff"];
        buf_aug [label = "D4 Symmetry\n8x augmentation", color = "#0e7490", fillcolor = "#ffffff"];

        buf_store -> buf_cap;
        buf_cap -> buf_aug;

        // Keep stage internals compact in LR layout (stack vertically)
        { rank = same; buf_store; buf_cap; buf_aug; }
    }

    // 3) Training
    subgraph cluster_training {
        label = "Training";
        fontsize = 12;
        style = "rounded";
        color = "#059669";
        bgcolor = "#ecfdf5";
        margin = 14;

        tr_sample [label = "Sample Batch\nbatch = 512", color = "#047857", fillcolor = "#ffffff"];
        tr_fwd [label = "Forward Pass\nAdam + AMP", color = "#047857", fillcolor = "#ffffff"];
        tr_loss [label = "Combined Loss\nL_pi (CE) + L_v (MSE)", color = "#047857", fillcolor = "#ffffff"];
        tr_lr [label = "Scheduled LR\n2 epochs / iteration", color = "#047857", fillcolor = "#ffffff"];

        tr_sample -> tr_fwd;
        tr_fwd -> tr_loss;
        tr_loss -> tr_lr;

        // Keep stage internals compact in LR layout (stack vertically)
        { rank = same; tr_sample; tr_fwd; tr_loss; tr_lr; }
    }

    // 4) Evaluation
    subgraph cluster_eval {
        label = "Evaluation Arena";
        fontsize = 12;
        style = "rounded";
        color = "#d97706";
        bgcolor = "#fffbeb";
        margin = 14;

        ev_match [label = "40 Games\nalternating Black / White", color = "#b45309", fillcolor = "#ffffff"];
        ev_det [label = "Deterministic Eval\ntau = 0, no Dirichlet", color = "#b45309", fillcolor = "#ffffff"];
        ev_pair [label = "Challenger vs Champion", color = "#b45309", fillcolor = "#ffffff"];

        ev_match -> ev_det;
        ev_det -> ev_pair;

        // Keep stage internals compact in LR layout (stack vertically)
        { rank = same; ev_match; ev_det; ev_pair; }
    }

    // 5) Promotion gate
    subgraph cluster_gate {
        label = "Promotion Gate";
        fontsize = 12;
        style = "rounded";
        color = "#a16207";
        bgcolor = "#fefce8";
        margin = 14;

        gate_check [label = "Win-rate >= 55% ?", color = "#92400e", fillcolor = "#ffffff"];
        gate_yes [label = "Update Champion", fillcolor = "#dcfce7", color = "#047857"];
        gate_no [label = "Discard Challenger", fillcolor = "#fee2e2", color = "#991b1b"];

        gate_check -> gate_yes [xlabel = "Yes", color = "#047857", fontcolor = "#047857"];
        gate_check -> gate_no [xlabel = "No", color = "#991b1b", fontcolor = "#991b1b"];
    }

    // Serving branch
    subgraph cluster_serving {
        label = "Serving";
        fontsize = 12;
        style = "rounded,dashed";
        color = "#9ca3af";
        bgcolor = "#f8fafc";
        fontcolor = "#6b7280";
        margin = 14;

        srv_api [label = "FastAPI + WebSocket", color = "#9ca3af", fillcolor = "#ffffff"];
        srv_mcts [label = "20 MCTS sims\nNative C++ engine", color = "#9ca3af", fillcolor = "#ffffff"];
        srv_state [label = "Stateless per request", color = "#9ca3af", fillcolor = "#ffffff"];

        srv_api -> srv_mcts [color = "#9ca3af"];
        srv_mcts -> srv_state [color = "#9ca3af"];
    }

    run_context [
        shape = note
        style = "filled"
        fillcolor = "#ffffff"
        color = "#94a3b8"
        fontcolor = "#334155"
        label = "~215 iterations across 4 runs\n(v4-day3 .. v4-day8 + recover)"
    ];

    // Main pipeline
    sp_out -> buf_store [ltail = cluster_selfplay, lhead = cluster_buffer];
    buf_aug -> tr_sample [ltail = cluster_buffer, lhead = cluster_training];
    tr_lr -> ev_match [ltail = cluster_training, lhead = cluster_eval];
    ev_pair -> gate_check [ltail = cluster_eval, lhead = cluster_gate];

    // Loop and serving edge from promoted champion
    gate_yes -> sp_mcts [
        style = dashed
        color = "#047857"
        fontcolor = "#047857"
        penwidth = 1.2
        headlabel = "next iteration"
        labeldistance = 1.3
        ltail = cluster_gate
        lhead = cluster_selfplay
        constraint = false
    ];
    gate_yes -> srv_api [
        style = dashed
        color = "#9ca3af"
        fontcolor = "#6b7280"
        label = "champion checkpoint"
        fontsize = 9
        ltail = cluster_gate
        lhead = cluster_serving
        constraint = false
    ];

    run_context -> tr_sample [arrowhead = none, style = dotted, color = "#94a3b8", constraint = false];

    subgraph {
        rank = same;
        gate_yes;
        gate_no;
    }
}
